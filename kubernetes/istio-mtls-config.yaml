# Istio Service Mesh mTLS Configuration
# East-West Traffic Encryption for Inter-Service Communication

apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: healthtourism
spec:
  mtls:
    mode: STRICT  # Enforce mTLS for all services

---
# Destination Rule for mTLS
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: default
  namespace: healthtourism
spec:
  host: "*.healthtourism.svc.cluster.local"
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL  # Use Istio's mTLS

---
# Authorization Policy - Deny all by default
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: deny-all
  namespace: healthtourism
spec:
  {}  # Empty spec = deny all

---
# Authorization Policy - Allow API Gateway to all services
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-api-gateway
  namespace: healthtourism
spec:
  selector:
    matchLabels:
      app: api-gateway
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"]
    to:
    - operation:
        methods: ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"]

---
# Authorization Policy - Allow inter-service communication
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-internal-services
  namespace: healthtourism
spec:
  rules:
  - from:
    - source:
        namespaces: ["healthtourism"]
    to:
    - operation:
        methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]

---
# Service Entry for external HTTPS endpoints
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: external-apis
  namespace: healthtourism
spec:
  hosts:
  - "api.stripe.com"
  - "api.sendgrid.com"
  - "polygon-rpc.com"
  ports:
  - number: 443
    name: https
    protocol: HTTPS
  resolution: DNS
  location: MESH_EXTERNAL

---
# Virtual Service for circuit breaking
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: circuit-breaker
  namespace: healthtourism
spec:
  host: "*.healthtourism.svc.cluster.local"
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        h2UpgradePolicy: UPGRADE
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
    outlierDetection:
      consecutive5xxErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50

---
# Request Authentication for JWT validation at mesh level
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: jwt-auth
  namespace: healthtourism
spec:
  selector:
    matchLabels:
      app: api-gateway
  jwtRules:
  - issuer: "healthtourism-auth-service"
    jwksUri: "http://auth-service.healthtourism.svc.cluster.local:8023/.well-known/jwks.json"
    forwardOriginalToken: true





